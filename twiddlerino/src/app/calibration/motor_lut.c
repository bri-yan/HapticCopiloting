/**
 * @file motor_lut.h
 * @brief Motor calibration look up tables
 * @author Yousif El-Wishahy (ywishahy@student.ubc.ca)
 */

/******************************************************************************/
/*                              I N C L U D E S                               */
/******************************************************************************/

//header for this file
#include "app/calibration/motor_lut.h"

#include "app/twid32_config.h"


/******************************************************************************/
/*                               D E F I N E S                                */
/******************************************************************************/

#define LUT_LENGTH 100U

/******************************************************************************/
/*                              T Y P E D E F S                               */
/******************************************************************************/

/******************************************************************************/
/*            P R I V A T E  F U N C T I O N  P R O T O T Y P E S             */
/******************************************************************************/

static float interpolate_1d(float dc);

/******************************************************************************/
/*               P R I V A T E  G L O B A L  V A R I A B L E S                */
/******************************************************************************/

//lookup values for dutycycle (0->1024)
static float lut_dc[100] = {
    0.0 ,
    10.0 ,
    20.0 ,
    31.0 ,
    41.0 ,
    51.0 ,
    62.0 ,
    72.0 ,
    82.0 ,
    93.0 ,
    103.0 ,
    113.0 ,
    124.0 ,
    134.0 ,
    144.0 ,
    155.0 ,
    165.0 ,
    175.0 ,
    186.0 ,
    196.0 ,
    206.0 ,
    217.0 ,
    227.0 ,
    237.0 ,
    248.0 ,
    258.0 ,
    268.0 ,
    279.0 ,
    289.0 ,
    299.0 ,
    310.0 ,
    320.0 ,
    330.0 ,
    341.0 ,
    351.0 ,
    362.0 ,
    372.0 ,
    382.0 ,
    393.0 ,
    403.0 ,
    413.0 ,
    424.0 ,
    434.0 ,
    444.0 ,
    455.0 ,
    465.0 ,
    475.0 ,
    486.0 ,
    496.0 ,
    506.0 ,
    517.0 ,
    527.0 ,
    537.0 ,
    548.0 ,
    558.0 ,
    568.0 ,
    579.0 ,
    589.0 ,
    599.0 ,
    610.0 ,
    620.0 ,
    630.0 ,
    641.0 ,
    651.0 ,
    661.0 ,
    672.0 ,
    682.0 ,
    693.0 ,
    703.0 ,
    713.0 ,
    724.0 ,
    734.0 ,
    744.0 ,
    755.0 ,
    765.0 ,
    775.0 ,
    786.0 ,
    796.0 ,
    806.0 ,
    817.0 ,
    827.0 ,
    837.0 ,
    848.0 ,
    858.0 ,
    868.0 ,
    879.0 ,
    889.0 ,
    899.0 ,
    910.0 ,
    920.0 ,
    930.0 ,
    941.0 ,
    951.0 ,
    961.0 ,
    972.0 ,
    982.0 ,
    992.0 ,
    1003.0 ,
    1013.0 ,
    1024.0
    };

//lookup values for current (in amps)
static float lut_current[100] = {
    -0.001312 ,
    -0.001312 ,
    -0.001312 ,
    -0.001312 ,
    -0.001312 ,
    -0.001125 ,
    -0.001312 ,
    -0.001125 ,
    -0.001125 ,
    -0.001125 ,
    -0.001312 ,
    -0.001125 ,
    -0.001312 ,
    -0.0015 ,
    -0.001125 ,
    -0.000562 ,
    0.000562 ,
    0.00225 ,
    0.004312 ,
    0.006938 ,
    0.009 ,
    0.011625 ,
    0.01425 ,
    0.017438 ,
    0.020437 ,
    0.02325 ,
    0.026062 ,
    0.029625 ,
    0.032625 ,
    0.036 ,
    0.054375 ,
    0.05925 ,
    0.064125 ,
    0.069563 ,
    0.074063 ,
    0.078562 ,
    0.084 ,
    0.069187 ,
    0.07425 ,
    0.079125 ,
    0.083812 ,
    0.082875 ,
    0.087375 ,
    0.092625 ,
    0.096937 ,
    0.108 ,
    0.106312 ,
    0.112875 ,
    0.131812 ,
    0.121875 ,
    0.126188 ,
    0.147 ,
    0.138 ,
    0.138375 ,
    0.157312 ,
    0.149813 ,
    0.156188 ,
    0.168938 ,
    0.168563 ,
    0.176812 ,
    0.184687 ,
    0.177563 ,
    0.188812 ,
    0.204 ,
    0.197437 ,
    0.203063 ,
    0.21 ,
    0.21675 ,
    0.222188 ,
    0.228375 ,
    0.2295 ,
    0.238125 ,
    0.2415 ,
    0.24825 ,
    0.25275 ,
    0.257437 ,
    0.269062 ,
    0.269625 ,
    0.271125 ,
    0.278437 ,
    0.288938 ,
    0.286125 ,
    0.296438 ,
    0.315375 ,
    0.305063 ,
    0.31275 ,
    0.311812 ,
    0.315 ,
    0.32325 ,
    0.321187 ,
    0.32475 ,
    0.330563 ,
    0.33375 ,
    0.338062 ,
    0.336563 ,
    0.340688 ,
    0.342375 ,
    0.343313 ,
    0.343313 ,
    0.33675
};

/******************************************************************************/
/*                       P U B L I C  F U N C T I O N S                       */
/******************************************************************************/

/******************************************************************************/
/*                      P R I V A T E  F U N C T I O N S                      */
/******************************************************************************/

//linear interpolation
//https://stackoverflow.com/questions/7091294/how-to-build-a-lookup-table-in-c-sdcc-compiler-with-linear-interpolation
static float interpolate_1d(float dc) {
    if (dc > MOTOR_DUTY_CYCLE_RES || dc < -MOTOR_DUTY_CYCLE_RES) {
        return lut_current[LUT_LENGTH-1];
    }

    for(uint16_t i = 0; i < LUT_LENGTH-1; i++ )
    {
        if ( lut_dc[i] <= dc && lut_dc[i+1] >= dc )
        {
            float diffx = dc - lut_dc[i+1];
            float diffn = lut_dc[i+1] - lut_dc[i];
            return lut_current[i] + ( lut_current[i+1] - lut_current[i] ) * diffx / diffn; 
        }
    }

    return lut_current[LUT_LENGTH-1];
}